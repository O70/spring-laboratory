<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="template-v2 :: app_template(~{::title}, ~{}, ~{}, ~{::.container-item}, ~{::script})">
<head>
    <title>Additional</title>
</head>
<body>
    <section class="content p-2 container-item">
        <div class="container-fluid">
            <el-tabs v-model="tab.selected" tab-position="left">
                <el-tab-pane
                    v-for="item in tab.list"
                    :key="item.id"
                    :name="item.field"
                    :label="item.name">
                </el-tab-pane>
                <el-form ref="form" :model="form" :disabled="disabled">
                    <el-form-item prop="field">
                        <el-input type="textarea" v-model="form[tab.selected]" :rows="25"></el-input>
                    </el-form-item>
                    <el-form-item class="text-right">
                        <el-button type="primary" @click="handleSave">保存</el-button>
                    </el-form-item>
                </el-form>
            </el-tabs>
        </div>
    </section>

    <script type="text/javascript" th:inline="javascript">
        Factory.Vue.build({
            data() {
                const uri = [[${#request.getRequestURI().toString()}]];
                return {
                    axios: Factory.Request,
                    api: '/api/hbis/additional',
                    code: `MENU_HBIS_NAV_${this.lastStr(uri)}`.toUpperCase(),
                    tab: {
                        selected: 0,
                        list: []
                    },
                    form: {
                        id: null,
                        professional: null,
                        pit: null,
                        pat: null,
                        pct: null,
                        pnt: null,
                        peg: null,
                        cases: null,
                        cis: null,
                        cas: null,
                        ccs: null,
                        cms: null,
                        ceg: null,
                        culture: null,
                        cev: null,
                        cra: null,
                        ctb: null
                    },
                    rules: {
                        field: { required: true, message: '请填写' }
                    },
                    disabled: true
                }
            },
            created() {
                this.axios.get(`/api/menu/down/${this.code}`).then(data => {
                    data.forEach(it => { it.field = this.lastStr(it.url); });
                    this.$set(this.tab, 'list', data);
                    this.tab.selected = this.tab.list[0].field;
                });

                this.axios.get(this.api).then(data => {
                    Object.assign(this.form, data);
                    this.disabled = false;
                });
            },
            methods: {
                lastStr(s) {
                    return s.substring(s.lastIndexOf('/') + 1);
                },
                handleSave() {
                    const { id } = this.form;
                    const field = this.tab.selected;
                    const data = { id, [field]: this.form[field] };
                    const method = id ? this.axios.put : this.axios.post;
                    method(this.api, data).then(data => this.$set(this.form, 'id', data.id));
                }
            }
        });
    </script>
</body>
</html>
