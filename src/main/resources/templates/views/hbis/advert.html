<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="template :: app_template(~{::title}, ~{::div.content-wrapper}, ~{::script})">
<head>
    <title>Advertising</title>
</head>
<body>
    <div class="content-wrapper">
        <el-upload
            :action="api"
            list-type="picture-card"
            multiple
            :headers="upload.headers"
            :file-list="upload.list"
            :on-success="handleSuccess">
            <i slot="default" class="el-icon-plus"></i>
            <div slot="file" slot-scope="{file}">
                <img class="el-upload-list__item-thumbnail" :src="file.url"/>
                <span class="el-upload-list__item-actions">
                    <span class="el-upload-list__item-preview" @click="handlePreview(file)">
                        <i class="el-icon-zoom-in"></i>
                    </span>
                    <span class="el-upload-list__item-delete" @click="handleRemove(file)">
                        <i class="el-icon-delete"></i>
                    </span>
                </span>
            </div>
        </el-upload>

        <el-dialog :visible.sync="dialog.visible">
            <img width="100%" :src="dialog.src"/>
        </el-dialog>
    </div>

    <script type="text/javascript">
        Factory.Vue.build({
            data() {
                return {
                    axios: Factory.Request,
                    api: '/api/adverts',
                    dialog: {
                        visible: false,
                        src: ''
                    },
                    upload: {
                        headers: {},
                        list: []
                    }
                }
            },
            created() {
                this.list();
            },
            mounted() {
                const csrf = id => document.getElementById(id).getAttribute('content');
                this.$set(this.upload.headers, csrf('_csrf_header'), csrf('_csrf_token'));
            },
            methods: {
                list() {
                    this.axios.get(this.api).then(data => this.$set(this.upload, 'list', data));
                },
                handleSuccess(res, file) {
                    Object.assign(file, res);
                },
                handlePreview(file) {
                    this.dialog.src = file.url;
                    this.dialog.visible = true;
                },
                handleRemove({ id, fid }) {
                    const list = this.upload.list;
                    list.splice(list.findIndex(f => f.id === id), 1);

                    // TODO: Inaccessible
                    // this.axios.delete(`${this.api}/${id}`);
                    this.axios.delete(this.api, { params: { id, fid } });
                }
            }
        });
    </script>
</body>
</html>
